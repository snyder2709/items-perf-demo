<template>
  <div class="load-test-docs">

    <h1>Нагрузочное тестирование эндпоинта</h1>
    <h2>Общая цель</h2>
    <p>
      Данное тестирование направлено на проверку производительности эндпоинта получения списка <code>items</code>
      при высокой частоте запросов и анализ эффективности проведённых оптимизаций.
    </p>
    <hr />


    <h2>Внесённые оптимизации</h2>
    <ul>
      <li>Переход с offset-пагинации на cursor-based пагинацию</li>
      <li>Кэширование результатов запросов на уровне приложения</li>
      <li>Оптимизация структуры запроса к базе данных</li>
      <li>Добавлена пакетная отправка запросов с фронтенда</li>
      <li>Использование пула подключений к базе данных с ограничением до 50 соединений</li>
    </ul>

    <section class="alert-block batch-limit">
      <h3>Ограничение режима <code>batch</code></h3>
      <p>
        В режиме <strong>batch</strong> запросы выполняются параллельно, поэтому график времени
        <em>не отражает реальную нагрузку</em> и может вводить в заблуждение. График показывает
        время всего пула запросов, а не время выполнения конкретного запроса.
        Корректно отражается только итоговое
        время выполнения (<code>totalDuration</code>).
      </p>
      <p class="note">Требуется доработка логики измерений и визуализации.</p>
    </section>

    <h3>Результат оптимизаций</h3>
    <p>Метрики одного запуска где 10 запросов с одинаковыми параметрами</p>
    <table border="1" cellspacing="0" cellpadding="6">
      <thead>
        <tr>
          <th>Метод</th>
          <th>Общее время</th>
          <th>Итог</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>Пакетный вызов</td>
          <td><b>98 ms</b></td>
          <td>Самый эффективный</td>
        </tr>
        <tr>
          <td>Поочерёдный вызов</td>
          <td><b>137 ms</b></td>
          <td>В среднем медленнее на ~20%</td>
        </tr>
      </tbody>
    </table>
    <p>
      На уровне ощущений:
    </p>
    <ul>
      <li>После оптимизации добавления параллельных вызовов итоговое время прогона сильно сократилось</li>
    </ul>
    <hr />

    <h2>Инструкция по использованию страницы нагрузочного теста</h2>

    <h3>Настройка параметров нагрузки</h3>
    <p>На странице тестирования доступна форма, позволяющая управлять параметрами нагрузки на сервер:</p>
    <ul>
      <li><strong>Лимит записей</strong> – количество элементов, которые будут получены в каждом запросе.</li>
      <li><strong>Offset</strong> – смещение для пагинации с использованием offset (только для типа Offset).</li>
      <li><strong>Cursor</strong> – начальный идентификатор для пагинации с использованием курсора (только для типа
        Cursor).</li>
      <li><strong>Increment (шаг)</strong> – величина сдвига курсора или offset после каждого запроса. Шаг влияет на
        количество необходимых запросов.</li>
      <li><strong>Тип запроса</strong> – выбирается между Offset pagination и Cursor pagination.</li>
      <li><strong>Кол-во запросов</strong> – сколько запросов будет отправлено в рамках одного теста. Значение
        автоматически ограничивается исходя из выбранного шага и общего количества элементов.</li>
      <li><strong>Кэширование</strong> – включение или отключение использования кэша при запросах.</li>
      <li><strong>pollType</strong> – режим отправки запросов: <em>batch</em> (пакетно, параллельно) или
        <em>sequence</em> (поочерёдно, с задержкой).
      </li>
    </ul>


    <p>⚠ <strong>Примечания:</strong></p>
    <ul>
      <li>Если курсор превышает максимальный <code>id</code> в таблице, запросы будут возвращать пустой результат.</li>
      <li>После изменения шага (Increment) поле <strong>Количество запросов</strong> автоматически пересчитывается,
        чтобы суммарный сдвиг не выходил за предел таблицы.</li>
      <li>Поле <strong>Количество запросов</strong> не может быть меньше 1.</li>
    </ul>

    <hr />

    <h3>Отображение метрик</h3>
    <p>Ниже формы располагается график, отображающий динамику времени выполнения запросов.</p>

    <h4>Типы собираемых метрик</h4>
    <ul>
      <li>
        <strong>Время выполнения запроса к базе данных</strong>
        <ul>
          <li>Снимается на стороне бэкенда</li>
          <li>Реализовано через обёртку над методом обращения к БД</li>
          <li>Позволяет отследить чистое время работы базы данных</li>
        </ul>
      </li>
      <li>
        <strong>Время выполнения HTTP-запроса</strong>
        <ul>
          <li>Снимается на стороне фронтенда</li>
        </ul>
      </li>
    </ul>

    <p>График позволяет наглядно сравнить:</p>
    <ul>
      <li>Реальное время работы БД</li>
      <li>Общее время выполнения запроса</li>
    </ul>

  </div>

</template>

<script setup lang="ts">

</script>

<style scoped>
.load-test-docs {
  margin: 0 auto;
  padding: 0.4rem 2rem;
  color: var(--color-text-primary);
}

.batch-limit {
  background: #fff7ed;
  border: 1px solid #ffd8a8;
  padding: 12px 16px;
  border-radius: 8px;
  color: #663c00;
  max-width: 720px;
  font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
}

.batch-limit h3 {
  margin: 0 0 8px 0;
  font-size: 15px;
}

.batch-limit p {
  margin: 6px 0;
  font-size: 13px;
  line-height: 1.4;
}

.batch-limit .note {
  margin-top: 8px;
  font-weight: 600;
}
</style>
